/**
 * 公用上传控件
 * @type {{create}}
 */
var cwUpload=function(d){var b,g,l=WebUploader.Base.guid(),m={img:{title:"\u56fe\u7247\u683c\u5f0f\u6587\u4ef6",extensions:"gif,jpg,jpeg,bmp,png,psd,ico",mimeTypes:"image/*"},video:{title:"\u89c6\u9891\u683c\u5f0f\u6587\u4ef6",extensions:"avi,wma,rmvb,rm,flash,mp4,mid,3gp,flv,mov",mimeTypes:"video/*"},material:{title:"\u56fe\u7247\u548c\u89c6\u9891\u6587\u4ef6",extensions:"gif,jpg,jpeg,bmp,png,psd,ico,avi,wma,rmvb,rm,flash,mp4,mid,3gp,flv,mov",mimeTypes:"image/*,video/*"},file:{title:"\u6587\u4ef6\u683c\u5f0f\u6587\u4ef6",extensions:"rar,zip,doc,xls,docx,xlsx,pdf,txt",mimeTypes:"application/*,text/plain"}};return{create:function(a,f){var n="undefined"===typeof a.dom?"#picker":a.dom,p="undefined"===typeof a.url?null:a.url,q="undefined"===typeof a.auto?!1:a.auto,r="undefined"===typeof a.size?null:a.size,t="undefined"===typeof a.thumb?null:a.thumb,u="undefined"===typeof a.compress?null:a.compress,v="undefined"===typeof a.filename?"file":a.filename,k=d("undefined"===typeof a.list?"#thelist":a.list),h=null;"object"===typeof a.accept?h=a.accept:"string"===typeof a.type&&(h=m[a.type]);WebUploader.Uploader.register({"before-send-file":"beforeSendFile","before-send":"beforeSend","after-send-file":"afterSendFile"},{beforeSendFile:function(c){var a=d("#"+c.id),b=WebUploader.Deferred();(new WebUploader.Uploader).md5File(c).progress(function(c){a.find("p.state").html('\u6b63\u5728\u8bfb\u53d6\u6587\u4ef6\u4fe1\u606f\uff08\x3cfont color\x3d"red"\x3e\x3cstrong\x3e'+parseInt(100*c)+"%\x3c/strong\x3e\x3c/font\x3e\uff09...")}).then(function(c){g=c;a.find("p.state").html("\u6210\u529f\u83b7\u53d6\u6587\u4ef6\u4fe1\u606f");b.resolve()});return b.promise()},beforeSend:function(c){this.owner.options.formData.chunkSize=c.end-c.start;this.owner.options.formData.fileMd5=g},afterSendFile:function(){}});b=WebUploader.create({swf:"webuploader/Uploader.swf",server:p,auto:q,pick:{id:n,multiple:!1},resize:!1,chunked:!0,chunkSize:2097152,fileVal:v,threads:1,formData:{guid:l,fileMd5:g},fileNumLimit:1,fileSingleSizeLimit:r,duplicate:!0,accept:h,thumb:t,compress:u});b.on("fileQueued",function(c){k.append('\x3cdiv id\x3d"'+c.id+'" class\x3d"item"\x3e\x3ch4 class\x3d"info"\x3e'+c.name+'\x3c/h4\x3e\x3cp class\x3d"state"\x3e\u7b49\u5f85\u4e0a\u4f20\uff0c\u8bf7\u6309\u201c\x3cfont color\x3d"red"\x3e\u5f00\u59cb\u4e0a\u4f20\x3c/font\x3e\u201d\x3c/p\x3e\x3c/div\x3e')});b.on("uploadAccept",function(c,a){if(!a.state){var e=c.file;b.cancelFile(e);d("#"+e.id).find("p.state").html('\x3cfont color\x3d"red"\x3e'+a.msg+"\x3c/font\x3e");d("#"+e.id).find(".progress").fadeOut()}});b.on("uploadProgress",function(c,a){var b=d("#"+c.id),e=b.find(".progress .progress-bar"),f=100*a;e.length||(e=d('\x3cdiv class\x3d"progress progress-striped active"\x3e\x3cdiv class\x3d"progress-bar" role\x3d"progressbar" style\x3d"width: 0%"\x3e\x3c/div\x3e\x3c/div\x3e').appendTo(b).find(".progress-bar"));b.find("p.state").text("\u4e0a\u4f20\u4e2d...");e.css("width",f+"%");e.text(parseInt(f)+"%")});b.on("uploadError",function(a,b){d("#"+a.id).find("p.state").html('\x3cfont color\x3d"red"\x3e\u4e0a\u4f20\u9519\u8bef\uff1a'+b+"\x3c/font\x3e")});b.on("uploadSuccess",function(a,b){b.state?d("#"+a.id).find("p.state").text("\u5df2\u4e0a\u4f20"):d("#"+a.id).find("p.state").html('\x3cfont color\x3d"red"\x3e'+b.msg+"\x3c/font\x3e");"function"===typeof f&&f("uploadSuccess",b)});b.on("uploadComplete",function(a){d("#"+a.id).find(".progress").fadeOut()});b.on("error",function(a){var b="";switch(a){case "Q_EXCEED_NUM_LIMIT":b="\u5355\u6b21\u4e0a\u4f20\u53ea\u80fd\u4e0a\u4f20\u4e00\u4e2a\u6587\u4ef6"}b&&k.next(".help-block").html('\x3cfont color\x3d"red"\x3e'+b+"\x3c/font\x3e")});b.on("all",function(a){"function"===typeof f&&f("all",a)});return b}}}(jQuery);